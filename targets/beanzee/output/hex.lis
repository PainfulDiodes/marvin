hex.asm:
     1                              PUBLIC hex_byte_val
     2                              PUBLIC putchar_hex
     3                          
     4                              EXTERN putchar
     5                          
     6                          ; string subroutines
     7                          
     8                          ; read 2 ASCII hex chars from memory by HL pointer, return converted value in A and advance HL pointer
     9                          hex_byte_val:
    10                              ; preserve BC
    11  0000  c5                    push bc
    12                              ; load 1st character from memory
    13  0001  7e                    ld a,(hl)
    14                              ; end of string?
    15  0002  fe00                  cp 0
    16                              ; yes: no value - return zero
    17  0004  2819                  jr z,_hex_byte_val_zero
    18                              ; no:
    19                              ; advance the buffer pointer
    20  0006  23                    inc hl
    21                              ; convert first hex digit
    22  0007  cd2300                call hex_val
    23                              ; shift left 4 bits to put value into top nibble
    24  000a  cb27                  sla a
    25  000c  cb27                  sla a
    26  000e  cb27                  sla a
    27  0010  cb27                  sla a
    28                              ; cache the result
    29  0012  47                    ld b,a
    30                              ; load 2nd character from memory
    31  0013  7e                    ld a,(hl)
    32                              ; end of string?
    33  0014  fe00                  cp 0
    34                              ; yes: incomplete byte - return zero
    35  0016  2807                  jr z,_hex_byte_val_zero
    36                              ; advance the buffer pointer
    37  0018  23                    inc hl
    38                              ; and convert 2nd hex digit
    39  0019  cd2300                call hex_val
    40                              ; add first and second digits
    41  001c  80                    add a,b
    42                              ; restore BC
    43  001d  c1                    pop bc
    44  001e  c9                    ret
    45                          _hex_byte_val_zero:
    46                              ; zero return value
    47  001f  3e00                  ld a,0
    48                              ; restore BC
    49  0021  c1                    pop bc
    50  0022  c9                    ret
    51                          
    52                          ; convert an ASCII hex char in A to a number value (lower 4 bits)
    53                          hex_val:
    54                              ; is it lowercase alphabetic?
    55  0023  fe61                  cp 'a'
    56                              ; no: uppercase/numeric
    57  0025  3803                  jr c,_hex_val_u_n
    58                              ; yes: alphabetic
    59  0027  d657                  sub 'a'-0x0a
    60  0029  c9                    ret
    61                          _hex_val_u_n:
    62                              ; is it uppercase alphabetic?
    63  002a  fe41                  cp 'A'
    64                              ; no: numeric
    65  002c  3803                  jr c,_hex_val_n
    66                              ; y:
    67  002e  d637                  sub 'A'-0x0a
    68  0030  c9                    ret
    69                          _hex_val_n:
    70                              ; numeric
    71  0031  d630                  sub '0'
    72  0033  c9                    ret
    73                          
    74                          ; convert value in A into an ASCII pair and send to console
    75                          putchar_hex:
    76  0034  f5                    push af
    77  0035  c5                    push bc
    78                              ; stash in B
    79  0036  47                    ld b,a
    80                              ; shift A right x4 e.g. transform 10110010 to 00001011
    81  0037  cb3f                  srl a
    82  0039  cb3f                  srl a
    83  003b  cb3f                  srl a
    84  003d  cb3f                  srl a
    85                              ; most significant digit
    86  003f  cd4b00                call _putchar_hex_dgt
    87                              ; recover from stash
    88  0042  78                    ld a,b
    89                              ; clear the top 4 bits
    90  0043  e60f                  and 0b00001111
    91                              ; least significant digit
    92  0045  cd4b00                call _putchar_hex_dgt
    93  0048  c1                    pop bc
    94  0049  f1                    pop af
    95  004a  c9                    ret
    96                          _putchar_hex_dgt:
    97                              ; is it an alpha or numeric?
    98  004b  fe0a                  cp 0x0a
    99                              ; numeric
   100  004d  3806                  jr c,_putchar_hex_n
   101                              ; alpha
   102                              ; for alpha add the base ascii for 'a' but then sub 10 / 0x0a as hex 'a' = 10d
   103  004f  c657                  add a,'a'-0x0a
   104  0051  cd0000                call putchar
   105  0054  c9                    ret
   106                          _putchar_hex_n:
   107                              ; for numeric add the base ascii for '0'
   108  0055  c630                  add a,'0'
   109  0057  cd0000                call putchar
   110  005a  c9                    ret
   111                          
