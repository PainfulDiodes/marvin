UM245R.asm:
     1                              INCLUDE "asm/main.inc"
../asm/main.inc:
     1                          IFNDEF _MAIN_INC
     2                          DEFINE _MAIN_INC
     3                          
     4                          ; start of user RAM
     5                          RAMSTART equ 0x8000
     6                          
     7                          ; 8-byte status area
     8                          CONSOLE_STATUS equ 0xf000
     9                          ; 8-byte keyscan buffer
    10                          KEY_MATRIX_BUFFER equ 0xf010
    11                          ; command buffer
    12                          CMD_BUFFER equ 0xf020
    13                          ; this should really be 0x0000 as the CPU will dec SP before PUSH
    14                          STACK equ 0xffff
    15                          
    16                          UM245R_CTRL equ 0 ; serial control port
    17                          UM245R_DATA equ 1 ; serial data port
    18                          KEYSCAN_OUT equ 2 ; either 2 or 3 will work
    19                          KEYSCAN_IN  equ 3 ; either 2 or 3 will work
    20                          LCD_CTRL    equ 4 ; LCD control port
    21                          LCD_DATA    equ 5 ; LCD data port
    22                          GPIO_OUT    equ 6 ; either 6 or 7 will work
    23                          GPIO_IN     equ 7 ; either 6 or 7 will work
    24                          
    25                          CONSOLE_STATUS_USB equ 1
    26                          CONSOLE_STATUS_BEANBOARD equ 2
    27                          
    28                          ENDIF
    29                          
UM245R.asm:
     2                              INCLUDE "asm/escapestring.inc"
../asm/escapestring.inc:
     1                          IFNDEF _ESCAPESTRING_INC
     2                          DEFINE _ESCAPESTRING_INC
     3                          
     4                          ; escape character constants for assembler compatibility
     5                          ; sjasmplus requires double quotes around escape sequences: "\n" and would not interpret '\n' but truncate
     6                          ; z88dk-z80asm requires single quotes around so would correctly interpret '\n' but reject "\n"
     7                          
     8                          ESC_B equ 0x08 ; \b
     9                          ESC_T equ 0x09 ; \t
    10                          ESC_N equ 0x0a ; \n
    11                          ESC_R equ 0x0d ; \r
    12                          ESC_E equ 0x1b ; \e
    13                          SLASH equ 0x5c ; \\
    14                          QUOTE equ 0x27 ; \'
    15                          
    16                          ENDIF
    17                          
UM245R.asm:
     3                          
     4                              PUBLIC usb_readchar
     5                              PUBLIC usb_putchar
     6                              PUBLIC usb_puts
     7                          
     8                          ; It is assumed that UM245R status signals are gated to the data bus as an IO port where:
     9                          ; /TXE = bit 0
    10                          ; /RXF = bit 1
    11                          ; As per:
    12                          ; https://github.com/PainfulDiodes/z80-breadboard-computer
    13                          ;
    14                          ; line endings are translated:
    15                          ; incoming line endings from the terminal are expected to be \r
    16                          ; and are tranlslated to \n
    17                          ; (\r\n would count as 2 line endings)
    18                          ; and outgoing line endings are sent as \r\n
    19                          ; externally this is consistent with VT100/ANSI terminal behaviour
    20                          ; and internally line endings are always \n
    21                          
    22                          ; get character and return in A
    23                          usb_readchar:
    24                              ; get the USB status
    25  0000  db00                  in a,(UM245R_CTRL)
    26                              ; data to read? (active low)
    27  0002  cb4f                  bit 1,a
    28                              ; no, the buffer is empty
    29  0004  2008                  jr nz,_usb_no_char
    30                              ; yes, read the received char
    31  0006  db01                  in a,(UM245R_DATA)
    32                              ; is CR?
    33  0008  fe0d                  cp ESC_R
    34                              ; no:
    35  000a  c0                    ret nz
    36                              ; yes: convert CR to LF
    37  000b  3e0a                  ld a, ESC_N
    38  000d  c9                    ret
    39                          _usb_no_char:
    40  000e  3e00                  ld a,0
    41  0010  c9                    ret
    42                          
    43                          usb_putchar:
    44                              ; newline?
    45  0011  fe0a                  cp ESC_N
    46                              ; no: just send the char
    47  0013  2007                  jr nz,_do_usb_put
    48  0015  3e0d                  ld a, ESC_R
    49  0017  cd2000                call _usb_put
    50  001a  3e0a                  ld a, ESC_N
    51                          _do_usb_put:
    52  001c  cd2000                call _usb_put
    53  001f  c9                    ret
    54                          
    55                          ; transmit character in A
    56                          _usb_put:
    57  0020  c5                    push bc
    58                              ; stash the transmit character
    59  0021  47                    ld b,a
    60                          _usb_put_loop:
    61                              ; get the USB status
    62  0022  db00                  in a,(UM245R_CTRL)
    63                              ; ready to transmit? (active low)
    64  0024  cb47                  bit 0,a
    65                              ; no: bit is high
    66  0026  20fa                  jr nz,_usb_put_loop
    67                              ; yes: restore the stashed transmit character
    68  0028  78                    ld a,b
    69                              ; transmit the character
    70  0029  d301                  out (UM245R_DATA),a
    71  002b  c1                    pop bc
    72  002c  c9                    ret
    73                          
    74                          ; print a zero-terminated string pointed to by hl to the USB
    75                          usb_puts:
    76  002d  e5                    push hl
    77                          _usb_puts_loop:
    78                              ; get character from string
    79  002e  7e                    ld a,(hl)
    80                              ; is it zero?
    81  002f  fe00                  cp 0
    82                              ; yes
    83  0031  2807                  jr z, _usb_puts_end
    84                              ; no: send character
    85  0033  cd1100                call usb_putchar
    86                              ; next character position
    87  0036  23                    inc hl
    88                              ; loop for next character
    89  0037  c32e00                jp _usb_puts_loop
    90                          _usb_puts_end:
    91  003a  e1                    pop hl
    92  003b  c9                    ret
    93                          
    94                          
