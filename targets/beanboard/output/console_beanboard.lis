console_beanboard.asm:
     1                              INCLUDE "asm/main.inc"
../asm/main.inc:
     1                          IFNDEF _MAIN_INC
     2                          DEFINE _MAIN_INC
     3                          
     4                          ; start of user RAM
     5                          RAMSTART equ 0x8000
     6                          
     7                          ; 8-byte status area
     8                          CONSOLE_STATUS equ 0xf000
     9                          ; 8-byte keyscan buffer
    10                          KEY_MATRIX_BUFFER equ 0xf010
    11                          ; command buffer
    12                          CMD_BUFFER equ 0xf020
    13                          ; this should really be 0x0000 as the CPU will dec SP before PUSH
    14                          STACK equ 0xffff
    15                          
    16                          UM245R_CTRL equ 0 ; serial control port
    17                          UM245R_DATA equ 1 ; serial data port
    18                          KEYSCAN_OUT equ 2 ; either 2 or 3 will work
    19                          KEYSCAN_IN  equ 3 ; either 2 or 3 will work
    20                          LCD_CTRL    equ 4 ; LCD control port
    21                          LCD_DATA    equ 5 ; LCD data port
    22                          GPIO_OUT    equ 6 ; either 6 or 7 will work
    23                          GPIO_IN     equ 7 ; either 6 or 7 will work
    24                          
    25                          CONSOLE_STATUS_USB equ 1
    26                          CONSOLE_STATUS_BEANBOARD equ 2
    27                          
    28                          ENDIF
    29                          
console_beanboard.asm:
     2                          
     3                              PUBLIC getchar
     4                              PUBLIC readchar
     5                              PUBLIC putchar
     6                              PUBLIC puts
     7                          
     8                              EXTERN usb_readchar
     9                              EXTERN usb_putchar
    10                              EXTERN key_readchar
    11                              EXTERN lcd_putchar
    12                          
    13                          ; wait for a character and return in A
    14                          getchar:
    15  0000  cd0800                call readchar
    16  0003  fe00                  cp 0
    17  0005  c0                    ret nz
    18  0006  18f8                  jr getchar
    19                          
    20                          ; read a character from the console and return in A - return 0 if there is no character
    21                          readchar:
    22  0008  e5                    push hl
    23  0009  2100f0                ld hl,CONSOLE_STATUS
    24  000c  3e02                  ld a,CONSOLE_STATUS_BEANBOARD
    25  000e  a6                    and (hl)
    26  000f  2007                  jr nz,_readchar_beanboard
    27  0011  3e01                  ld a,CONSOLE_STATUS_USB
    28  0013  a6                    and (hl)
    29  0014  2007                  jr nz,_readchar_usb
    30  0016  1808                  jr _readchar_end
    31                          _readchar_beanboard:
    32  0018  cd0000                call key_readchar
    33  001b  1803                  jr _readchar_end
    34                          _readchar_usb:
    35  001d  cd0000                call usb_readchar
    36                          _readchar_end:
    37  0020  e1                    pop hl
    38  0021  c9                    ret
    39                          
    40                          ; sent character in A to the console
    41                          putchar:
    42  0022  e5                    push hl
    43  0023  c5                    push bc
    44  0024  47                    ld b,a
    45  0025  2100f0                ld hl,CONSOLE_STATUS
    46  0028  3e02                  ld a,CONSOLE_STATUS_BEANBOARD
    47  002a  a6                    and (hl)
    48  002b  2007                  jr nz,_putchar_beanboard
    49  002d  3e01                  ld a,CONSOLE_STATUS_USB
    50  002f  a6                    and (hl)
    51  0030  2008                  jr nz,_putchar_usb
    52  0032  180a                  jr _putchar_end
    53                          _putchar_beanboard:
    54  0034  78                    ld a,b
    55  0035  cd0000                call lcd_putchar
    56  0038  1804                  jr _putchar_end
    57                          _putchar_usb:
    58  003a  78                    ld a,b
    59  003b  cd0000                call usb_putchar
    60                          _putchar_end:
    61  003e  78                    ld a,b
    62  003f  c1                    pop bc
    63  0040  e1                    pop hl
    64  0041  c9                    ret
    65                          
    66                          ; print a zero-terminated string pointed to by hl to the console
    67                          puts:
    68  0042  e5                    push hl
    69                          _puts_loop:
    70                              ; get character from string
    71  0043  7e                    ld a,(hl)
    72                              ; is it zero?
    73  0044  fe00                  cp 0
    74                              ; yes
    75  0046  2807                  jr z, _puts_end
    76                              ; no: send character
    77  0048  cd2200                call putchar
    78                              ; next character position
    79  004b  23                    inc hl
    80                              ; loop for next character
    81  004c  c34300                jp _puts_loop
    82                          _puts_end:
    83  004f  e1                    pop hl
    84  0050  c9                    ret
    85                          
