marvin_beanboard.asm:
     1                              INCLUDE "asm/system.inc"
../asm/system.inc:
     1                          IFNDEF _MAIN_INC
     2                          DEFINE _MAIN_INC
     3                          
     4                          ; start of user RAM
     5                          RAMSTART equ 0x8000
     6                          
     7                          ; 8-byte status area
     8                          CONSOLE_STATUS equ 0xf000
     9                          ; 8-byte keyscan buffer
    10                          KEY_MATRIX_BUFFER equ 0xf010
    11                          ; command buffer
    12                          CMD_BUFFER equ 0xf020
    13                          ; this should really be 0x0000 as the CPU will dec SP before PUSH
    14                          STACK equ 0xffff
    15                          
    16                          UM245R_CTRL equ 0 ; serial control port
    17                          UM245R_DATA equ 1 ; serial data port
    18                          KEYSCAN_OUT equ 2 ; either 2 or 3 will work
    19                          KEYSCAN_IN  equ 3 ; either 2 or 3 will work
    20                          LCD_CTRL    equ 4 ; LCD control port
    21                          LCD_DATA    equ 5 ; LCD data port
    22                          GPIO_OUT    equ 6 ; either 6 or 7 will work
    23                          GPIO_IN     equ 7 ; either 6 or 7 will work
    24                          
    25                          CONSOLE_STATUS_USB equ 1
    26                          CONSOLE_STATUS_BEANBOARD equ 2
    27                          
    28                          ENDIF
    29                          
marvin_beanboard.asm:
     2                          
     3                              EXTERN MARVIN
     4                              EXTERN PROMPT
     5                              EXTERN putchar
     6                              EXTERN getchar
     7                              EXTERN readchar
     8                              EXTERN puts
     9                              EXTERN putchar_hex
    10                              EXTERN hex_byte_val
    11                              EXTERN lcd_init
    12                              EXTERN lcd_putchar
    13                              EXTERN key_readchar
    14                              EXTERN beanboard_console_init
    15                          
    16                              ORG MARVINORG
    17  0000  31ffff                ld sp, STACK
    18  0003  cd0000                call lcd_init
    19  0006  cd0000                call beanboard_console_init
    20                          
    21                          ; jump table at fixed addresses - must match jumptable.inc
    22  0009  00000000000000    ALIGN 0x0010
    23  0010  c30000                jp MARVIN           ; 0x0010 - warm start (enter monitor)
    24  0013  c30000                jp PROMPT           ; 0x0013 - monitor prompt
    25  0016  c30000                jp putchar          ; 0x0016 - write character (A = char)
    26  0019  c30000                jp getchar          ; 0x0019 - wait for character (returns A)
    27  001c  c30000                jp readchar         ; 0x001C - non-blocking read (returns A, 0 = none)
    28  001f  c30000                jp puts             ; 0x001F - print string (HL = address, zero-terminated)
    29  0022  c30000                jp putchar_hex      ; 0x0022 - print A as two hex digits
    30  0025  c30000                jp hex_byte_val     ; 0x0025 - parse hex pair from (HL), advance HL
    31  0028  c30000                jp lcd_init         ; 0x0028 - initialise LCD
    32  002b  c30000                jp lcd_putchar      ; 0x002B - write character to LCD
    33  002e  c30000                jp key_readchar     ; 0x002E - read keyboard
    34                          
