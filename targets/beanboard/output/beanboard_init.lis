beanboard_init.asm:
     1                              INCLUDE "asm/main.inc"
../asm/main.inc:
     1                          IFNDEF _MAIN_INC
     2                          DEFINE _MAIN_INC
     3                          
     4                          ; start of user RAM
     5                          RAMSTART equ 0x8000
     6                          
     7                          ; 8-byte status area
     8                          CONSOLE_STATUS equ 0xf000
     9                          ; 8-byte keyscan buffer
    10                          KEY_MATRIX_BUFFER equ 0xf010
    11                          ; command buffer
    12                          CMD_BUFFER equ 0xf020
    13                          ; this should really be 0x0000 as the CPU will dec SP before PUSH
    14                          STACK equ 0xffff
    15                          
    16                          UM245R_CTRL equ 0 ; serial control port
    17                          UM245R_DATA equ 1 ; serial data port
    18                          KEYSCAN_OUT equ 2 ; either 2 or 3 will work
    19                          KEYSCAN_IN  equ 3 ; either 2 or 3 will work
    20                          LCD_CTRL    equ 4 ; LCD control port
    21                          LCD_DATA    equ 5 ; LCD data port
    22                          GPIO_OUT    equ 6 ; either 6 or 7 will work
    23                          GPIO_IN     equ 7 ; either 6 or 7 will work
    24                          
    25                          CONSOLE_STATUS_USB equ 1
    26                          CONSOLE_STATUS_BEANBOARD equ 2
    27                          
    28                          ENDIF
    29                          
beanboard_init.asm:
     2                          
     3                              PUBLIC beanboard_console_init
     4                          
     5                              EXTERN modifierkeys
     6                              EXTERN MOD_KEY_SHIFT
     7                          
     8                          ; determine which console should be active - Reset=beanboard, shift-Reset=USB
     9                          beanboard_console_init:
    10                              ; check for modifier keys being held down
    11  0000  cd0000                call modifierkeys
    12                              ; shift key down?
    13  0003  e600                  and MOD_KEY_SHIFT
    14                              ; yes shift
    15  0005  c20f00                jp nz,_beanboard_console_init_usb
    16                              ; no shift
    17  0008  3e02                  ld a,CONSOLE_STATUS_BEANBOARD
    18  000a  2100f0                ld hl,CONSOLE_STATUS
    19  000d  77                    ld (hl),a
    20  000e  c9                    ret
    21                          _beanboard_console_init_usb:
    22  000f  3e01                  ld a,CONSOLE_STATUS_USB
    23  0011  2100f0                ld hl,CONSOLE_STATUS
    24  0014  77                    ld (hl),a
    25  0015  c9                    ret
    26                          
